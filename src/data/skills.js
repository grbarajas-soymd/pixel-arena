// =============== SKILLS DATABASE ===============
import { state } from '../gameState.js';
import { AX, AW, MELEE } from '../constants.js';
import { en, dst, effEv, isStunned, blN, addBl, addCh, getSdm, addLog } from '../combat/engine.js';
import { spLightning, spLStrike, spFloat, spSparks, spFire, spPoison, spSmoke, spShadow, spStun, spDrips } from '../render/particles.js';
import { mkFollower } from '../combat/hero.js';

export const ALL_SKILLS=[
  {id:'chainLightning',icon:'\u26A1',name:'Chain Lightning',source:'Mage',desc:'dmg+stun 5sCD 35mp (HP)',bcd:5000,cost:35,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<35||d>(h.spellRange||400))return false;h.resource-=35;h.spells.skill0.cd=5000;h.castAnim=1;if(Math.random()<effEv(e)*0.6){addLog(t,'Chain DODGED!','miss');return true}var dm=(180+(h.maxHp||1500)*0.05)*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;spLightning(h.x,h.y-40,e.x,e.y-30);spFloat(e.x,e.y-60,'\u26A1'+Math.round(dm),'#44ddbb');addLog(t,'Chain>'+e.name+' '+Math.round(dm),'shock');e.shocked=true;e.shockedEnd=t+3000;e.slow=0.12;e.slowEnd=t+1500;if(!e.stealthed&&!(e.type==='barbarian')){e.stunEnd=t+450;spStun(e.x,e.y-50)}return true}},
  {id:'lightningBolt',icon:'\u{1F537}',name:'Lightning Bolt',source:'Mage',desc:'dmg+shock 2.5sCD 20mp (HP)',bcd:2500,cost:20,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<20||d>(h.spellRange||400))return false;h.resource-=20;h.spells.skill0.cd=2500;h.castAnim=1;if(Math.random()<effEv(e)*0.6){addLog(t,'Bolt DODGED!','miss');return true}var dm=(90+(h.maxHp||1500)*0.03)*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;spFloat(e.x,e.y-50,'\u26A1'+Math.round(dm),'#88ffdd');spSparks(e.x,e.y-30,3,'#44ddbb');addLog(t,'Bolt>'+e.name+' '+Math.round(dm),'shock');e.shocked=true;e.shockedEnd=t+2000;return true}},
  {id:'staticShield',icon:'\u{1F6E1}',name:'Static Shield',source:'Mage',desc:'shield 10sCD 45mp (DEF)',bcd:10000,cost:45,ai:function(h,t){if(h.spells.skill0.cd>0||(h.resource||0)<45||h.hp/h.maxHp>.65||h.shieldActive)return false;h.resource-=45;h.spells.skill0.cd=10000;h.shieldActive=true;h.shieldHp=320+(h.def||0)*4;h.shieldEnd=t+5000;h.castAnim=1;addLog(t,h.name+' Shield!','spell');return true}},
  {id:'huntersMark',icon:'\u{1F3AF}',name:"Hunter's Mark",source:'Ranger',desc:'slow+hit 8sCD 15res (AS)',bcd:8000,cost:15,ai:function(h,t){var e=en(h);if(h.spells.skill0.cd>0||blN(e)<1)return false;if(h.resource!==undefined){if(h.resource<15)return false;h.resource-=15;}var as=h.baseAS||0.5;e.slow=(.005+as*0.01)*blN(e);e.slowEnd=t+1500+Math.round(as*1200);h.markNext=true;addBl(e,t);h.spells.skill0.cd=8000;h.castAnim=1;addLog(t,h.name+' Mark!','spell');return true}},
  {id:'bloodlust',icon:'\u{1FA78}',name:'Bloodlust',source:'Ranger',desc:'AtkSpd+heal 12sCD 25res (AS)',bcd:12000,cost:25,ai:function(h,t){var e=en(h);if(h.spells.skill0.cd>0||blN(e)<2)return false;if(h.resource!==undefined){if(h.resource<25)return false;h.resource-=25;}var as=h.baseAS||0.5;h.blActive=true;h.blEnd=t+2000+Math.round(as*1200);h.blDmg=0;h.spells.skill0.cd=12000;h.castAnim=1;spFire(h.x,h.y-30,6);addLog(t,h.name+' Bloodlust!','spell');return true}},
  {id:'sacrifice',icon:'\u{1F525}',name:'Summon Pet',source:'Ranger',desc:'pet 15sCD 30res (DMG)',bcd:15000,cost:30,ai:function(h,t){if(h.spells.skill0.cd>0||h.followerAlive)return false;if(h.resource!==undefined){if(h.resource<30)return false;h.resource-=30;}h.follower=mkFollower(h);h.followerAlive=true;var bonus=Math.round(h.baseDmg||0);h.follower.hp+=bonus;h.follower.maxHp+=bonus;h.spells.skill0.cd=15000;h.castAnim=1;spFire(h.follower.x,h.follower.y-15,6);addLog(t,h.name+' summons pet!','summon');return true}},
  {id:'shadowStep',icon:'\u{1F4A8}',name:'Shadow Step',source:'Rogue',desc:'stealth 3.5sCD 25res (SPD)',bcd:3500,cost:25,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<25||d<=100||h.stealthed)return false;h.resource-=25;h.spells.skill0.cd=3500;h.castAnim=1;spShadow(h.x,h.y-20);h.x=Math.max(AX+25,Math.min(AX+AW-25,e.x+(e.x>h.x?50:-50)));h.y=e.y||h.y;h.stealthed=true;h.stealthEnd=t+1200+Math.round((h.moveSpeed||160)*5);h.combo=Math.min(h.maxCombo||5,(h.combo||0)+2);spShadow(h.x,h.y-20);addLog(t,h.name+' Shadow Step!','stealth');return true}},
  {id:'envenom',icon:'\u2620',name:'Envenom',source:'Rogue',desc:'poison 8sCD 25res (SPD)',bcd:8000,cost:25,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<25||d>(h.meleeRange||MELEE)+60)return false;h.resource-=25;h.spells.skill0.cd=8000;h.castAnim=1;h.envenomed=true;h.envenomedEnd=t+3500+Math.round((h.moveSpeed||160)*10);spPoison(h.x,h.y-30,6);addLog(t,h.name+' Envenom!','poison');return true}},
  {id:'smokeBomb',icon:'\u{1F4A3}',name:'Smoke Bomb',source:'Rogue',desc:'eva buff 12sCD 35res (EVA)',bcd:12000,cost:35,ai:function(h,t){if(h.spells.skill0.cd>0||(h.resource||0)<35||h.hp/h.maxHp>.55||h.smokeBombActive)return false;h.resource-=35;h.spells.skill0.cd=12000;h.castAnim=1;h.smokeBombActive=true;h.smokeBombEnd=t+3000+Math.round((h.evasion||0)*6000);h.smokeBombX=h.x;spSmoke(h.x,h.y-20,15);addLog(t,h.name+' Smoke Bomb!','stealth');return true}},
  {id:'charge',icon:'\u{1F4A5}',name:'Charge',source:'Warrior',desc:'dash+dmg+stun 5.5sCD (DMG+DEF)',bcd:5500,cost:0,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||d<100||d>350)return false;h.spells.skill0.cd=5500;h.castAnim=1;spSparks(h.x,h.y-20,6,'#cc4444');h.x=Math.max(AX+25,Math.min(AX+AW-25,e.x-(e.x>h.x?1:-1)*45));h.y=e.y||h.y;var dm=(h.baseDmg*1.5+(h.def||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;spFloat(e.x,e.y-60,'\u{1F4A5}'+Math.round(dm),'#cc4444');spSparks(e.x,e.y-30,8,'#ff6666');addLog(t,h.name+' CHARGE '+Math.round(dm)+'!','dmg');if(!e.stealthed&&!(e.type==='barbarian')){e.stunEnd=t+250;spStun(e.x,e.y-50)}return true}},
  {id:'warCry',icon:'\u{1F4E2}',name:'War Cry',source:'Warrior',desc:'weaken 10sCD (DEF)',bcd:10000,cost:0,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||d>150)return false;h.spells.skill0.cd=10000;h.castAnim=1;var sl=0.18+(h.def||0)*0.002;e.slow=Math.min(0.4,sl);e.slowEnd=t+2000+Math.round((h.maxHp||1500)*0.3);spSparks(h.x,h.y-30,6,'#ffaa44');addLog(t,h.name+' WAR CRY!','spell');return true}},
  {id:'frostNova',icon:'\u2744',name:'Frost Nova',source:'Mage',desc:'burst+slow 7sCD 30mp (DEF)',bcd:7000,cost:30,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<30||d>180)return false;h.resource-=30;h.spells.skill0.cd=7000;h.castAnim=1;if(Math.random()<effEv(e)*0.4){addLog(t,'Nova DODGED!','miss');return true}var dm=(80+(h.def||0)*3)*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;e.slow=0.3;e.slowEnd=t+2000;spSparks(h.x,h.y-30,10,'#88ccff');spFloat(e.x,e.y-60,'\u2744'+Math.round(dm),'#88ccff');addLog(t,'Frost Nova '+Math.round(dm),'spell');if(e.shocked&&state.bt<e.shockedEnd){if(!e.stealthed&&!(e.type==='barbarian')){e.stunEnd=t+500;spStun(e.x,e.y-50);addLog(t,e.name+' FROZEN!','stun')}}return true}},
  {id:'arcaneDrain',icon:'\u{1F49C}',name:'Arcane Drain',source:'Mage',desc:'dmg+heal 8sCD 25mp (HP)',bcd:8000,cost:25,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<25||d>(h.spellRange||400)||h.hp/h.maxHp>0.75)return false;h.resource-=25;h.spells.skill0.cd=8000;h.castAnim=1;if(Math.random()<effEv(e)*0.5){addLog(t,'Drain DODGED!','miss');return true}var dm=(60+(h.maxHp||1500)*0.03)*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;var hl=Math.round(40+(h.spellDmgBonus||0)*400);h.hp=Math.min(h.maxHp,h.hp+hl);h.totHeal=(h.totHeal||0)+hl;spSparks(e.x,e.y-30,5,'#aa88ff');spFloat(e.x,e.y-60,'\u{1F49C}'+Math.round(dm),'#aa88ff');spFloat(h.x,h.y-55,'+'+hl,'#44aa66');addLog(t,'Drain '+Math.round(dm)+' heal '+hl,'spell');return true}},
  {id:'rupture',icon:'\u{1FA78}',name:'Rupture',source:'Ranger',desc:'pop bleeds 6sCD 20res (AS)',bcd:6000,cost:20,ai:function(h,t){var e=en(h);if(h.spells.skill0.cd>0||blN(e)<2)return false;if(h.resource!==undefined){if(h.resource<20)return false;h.resource-=20;}var stacks=blN(e);var perStack=30+(h.baseAS||0.5)*80;var dm=Math.round(stacks*perStack*(1-Math.min(e.def/300,.8)));e.bleedStacks=[];e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;h.spells.skill0.cd=6000;h.castAnim=1;spSparks(e.x,e.y-30,stacks*3,'#cc4444');spFloat(e.x,e.y-60,'\u{1FA78}x'+stacks+' '+Math.round(dm),'#cc4444');addLog(t,'Rupture x'+stacks+' = '+Math.round(dm),'dmg');return true}},
  {id:'markedForDeath',icon:'\u{1F4A2}',name:'Marked for Death',source:'Ranger',desc:'vuln 3s 10sCD 20res (AS)',bcd:10000,cost:20,ai:function(h,t){var e=en(h);if(h.spells.skill0.cd>0||e.vulnerable)return false;if(h.resource!==undefined){if(h.resource<20)return false;h.resource-=20;}var amp=0.08+(h.baseAS||0.5)*0.08;e.vulnerable=true;e.vulnerableEnd=t+3000;e.vulnerableAmp=amp;h.spells.skill0.cd=10000;h.castAnim=1;spSparks(e.x,e.y-30,6,'#ff8844');spFloat(e.x,e.y-60,'VULNERABLE','#ff8844');addLog(t,e.name+' vulnerable +'+Math.round(amp*100)+'%!','spell');return true}},
  {id:'lacerate',icon:'\u{1F5E1}',name:'Lacerate',source:'Rogue',desc:'execute+bleed 8sCD 30res (EVA)',bcd:8000,cost:30,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<30||d>(h.meleeRange||MELEE)+80||e.hp/e.maxHp>0.7)return false;h.resource-=30;h.spells.skill0.cd=8000;h.castAnim=1;if(Math.random()<effEv(e)*0.3){addLog(t,'Lacerate DODGED!','miss');return true}var missingPct=1-e.hp/e.maxHp;var dm=h.baseDmg*(0.5+(h.evasion||0)*2)*missingPct*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;spSparks(e.x,e.y-30,8,'#ff2222');spFloat(e.x,e.y-60,'\u{1F5E1}'+Math.round(dm),'#ff2222');addLog(t,'Lacerate '+Math.round(dm)+' ('+Math.round(missingPct*100)+'%missing)','dmg');addBl(e,t);spDrips(e.x,e.y-20);return true}},
  {id:'riposte',icon:'\u{1F6E1}',name:'Riposte',source:'Rogue',desc:'counter 2s 10sCD 25res (EVA)',bcd:10000,cost:25,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<25||h.riposteActive||d>200)return false;h.resource-=25;h.spells.skill0.cd=10000;h.castAnim=1;h.riposteActive=true;h.riposteEnd=t+2000;h.riposteDmg=Math.round(h.baseDmg*0.8+(h.evasion||0)*400);spSparks(h.x,h.y-30,6,'#ccccff');spFloat(h.x,h.y-60,'RIPOSTE','#ccccff');addLog(t,h.name+' Riposte stance!','spell');return true}},
  {id:'battleTrance',icon:'\u{1F525}',name:'Battle Trance',source:'Warrior',desc:'DEF>DMG 3s 8sCD (DEF)',bcd:8000,cost:0,ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||h.tranceActive||d>250)return false;h.spells.skill0.cd=8000;h.castAnim=1;var dmgBonus=Math.round((h.def||0)*0.6);var defLoss=Math.round((h.def||0)*0.4);h.tranceActive=true;h.tranceEnd=t+3000;h.tranceDmg=dmgBonus;h.tranceDefLoss=defLoss;h.baseDmg+=dmgBonus;h.def-=defLoss;spSparks(h.x,h.y-30,8,'#ff4444');spFloat(h.x,h.y-60,'TRANCE +'+dmgBonus,'#ff4444');addLog(t,h.name+' Trance! +'+dmgBonus+' DMG','spell');return true}},
  {id:'thorns',icon:'\u{1F331}',name:'Thorns',source:'Warrior',desc:'reflect 4s 12sCD (DEF)',bcd:12000,cost:0,ai:function(h,t){if(h.spells.skill0.cd>0||h.thornsActive||h.hp/h.maxHp>0.6)return false;h.spells.skill0.cd=12000;h.castAnim=1;var pct=0.15+(h.def||0)*0.005;h.thornsActive=true;h.thornsEnd=t+4000;h.thornsPct=Math.min(0.5,pct);spSparks(h.x,h.y-30,8,'#44cc44');spFloat(h.x,h.y-60,'THORNS '+Math.round(pct*100)+'%','#44cc44');addLog(t,h.name+' Thorns! '+Math.round(pct*100)+'%','spell');return true}},
];

export const ALL_ULTS=[
  {id:'thunderstorm',icon:'\u26A1',name:'Thunderstorm',source:'Mage',desc:'5xdmg+heal @25%HP (HP)',bcd:Infinity,threshold:0.25,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.25)return false;h.spells.ultimate.used=true;h.ultActive=true;h.ultEnd=t+2500;h.ultStrikes=5;h.ultStrikeTimer=0;h.castAnim=1;spSparks(h.x,h.y-40,12,'#44ddbb');addLog(t,'\u26A1 '+h.name+' THUNDERSTORM!','ult');return true},proc:function(h,t,dt){if(!h.ultActive||!h.ultStrikes||h.ultStrikes<=0)return;h.ultStrikeTimer=(h.ultStrikeTimer||0)+dt;if(h.ultStrikeTimer>=450){h.ultStrikeTimer=0;h.ultStrikes--;var e=en(h);var dm=(120+(h.maxHp||1500)*0.05)*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;var hl=dm*0.42;h.hp=Math.min(h.maxHp,h.hp+hl);h.totHeal+=hl;spLStrike(e.x);spFloat(e.x,e.y-65,'\u26A1'+Math.round(dm),'#44ddbb');spFloat(h.x,h.y-55,'+'+Math.round(hl),'#44aa66');addLog(t,'Storm '+Math.round(dm)+' heal '+Math.round(hl),'ult')}}},
  {id:'rainOfFire',icon:'\u{1F525}',name:'Rain of Fire',source:'Ranger',desc:'invuln+burn @20%HP (AS)',bcd:Infinity,threshold:0.20,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.20)return false;h.spells.ultimate.used=true;h.ultActive=true;h.ultEnd=t+1500+Math.round((h.baseAS||0.5)*1200);h.castAnim=1;spFire(h.x,h.y-30,15);addLog(t,'\u{1F525} '+h.name+' RAIN OF FIRE!','ult');var be=en(h);be.burning=true;be.burnEnd=t+3000;be.burnDmg=Math.round(h.baseDmg*0.5);return true}},
  {id:'deathMark',icon:'\u2620',name:'Death Mark',source:'Rogue',desc:'stored dmg @20%HP (EVA)',bcd:Infinity,threshold:0.20,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.20)return false;h.spells.ultimate.used=true;h.castAnim=1;h.combo=h.maxCombo||5;var e=en(h);e.deathMarkTarget=true;e.deathMarkEnd=t+3000+Math.round((h.evasion||0)*5000);e.deathMarkDmg=0;spSparks(e.x,e.y-30,10,'#ff8800');spFloat(e.x,e.y-70,'DEATH MARK','#ff8800');addLog(t,'\u2620 '+h.name+' DEATH MARK!','ult');return true}},
  {id:'berserker',icon:'\u{1F480}',name:'Berserker Rage',source:'Warrior',desc:'+AS+Dmg @30%HP (DEF)',bcd:Infinity,threshold:0.30,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.30)return false;h.spells.ultimate.used=true;h.ultActive=true;h.ultEnd=t+3000+Math.round((h.def||0)*35);h.castAnim=1;spSparks(h.x,h.y-40,12,'#cc4444');spFloat(h.x,h.y-70,'BERSERKER','#ff4444');addLog(t,'\u{1F480} '+h.name+' BERSERKER RAGE!','ult');return true}},
  {id:'arcaneOverload',icon:'\u{1F4A0}',name:'Arcane Overload',source:'Mage',desc:'burst+burn+free spells @25%HP (HP)',bcd:Infinity,threshold:0.25,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.25)return false;h.spells.ultimate.used=true;h.castAnim=1;var e=en(h);var dm=(200+(h.maxHp||1500)*0.08)*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;e.burning=true;e.burnEnd=t+3000;e.burnDmg=Math.round(dm*0.15);h.freeSpellsActive=true;h.freeSpellsEnd=t+4000;spSparks(h.x,h.y-40,15,'#aa44ff');spFloat(e.x,e.y-65,'\u{1F4A0}'+Math.round(dm),'#aa44ff');spFloat(h.x,h.y-55,'FREE SPELLS','#aa88ff');addLog(t,'\u{1F4A0} '+h.name+' ARCANE OVERLOAD!','ult');return true}},
  {id:'primalFury',icon:'\u{1F43E}',name:'Primal Fury',source:'Ranger',desc:'beast mode @20%HP (AS)',bcd:Infinity,threshold:0.20,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.20)return false;h.spells.ultimate.used=true;h.primalActive=true;h.primalEnd=t+2000+Math.round((h.baseAS||0.5)*1500);h.castAnim=1;spFire(h.x,h.y-30,12);spFloat(h.x,h.y-70,'PRIMAL FURY','#ff8844');addLog(t,'\u{1F43E} '+h.name+' PRIMAL FURY!','ult');return true}},
  {id:'shadowDance',icon:'\u{1F3AD}',name:'Shadow Dance',source:'Rogue',desc:'perma-stealth @20%HP (EVA)',bcd:Infinity,threshold:0.20,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.20)return false;h.spells.ultimate.used=true;h.shadowDanceActive=true;h.shadowDanceEnd=t+2500+Math.round((h.evasion||0)*5000);h.stealthed=true;h.stealthEnd=h.shadowDanceEnd;h.castAnim=1;spShadow(h.x,h.y-20);spFloat(h.x,h.y-70,'SHADOW DANCE','#6644cc');addLog(t,'\u{1F3AD} '+h.name+' SHADOW DANCE!','ult');return true}},
  {id:'lastStand',icon:'\u{1F6E1}',name:'Last Stand',source:'Warrior',desc:'undying @30%HP (DEF)',bcd:Infinity,threshold:0.30,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.30)return false;h.spells.ultimate.used=true;h.lastStandActive=true;h.lastStandEnd=t+2500+Math.round((h.def||0)*25);h.castAnim=1;spSparks(h.x,h.y-40,12,'#ffcc22');spFloat(h.x,h.y-70,'LAST STAND','#ffcc22');addLog(t,'\u{1F6E1} '+h.name+' LAST STAND!','ult');return true}},
];
