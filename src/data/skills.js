// =============== SKILLS DATABASE ===============
import { state } from '../gameState.js';
import { AX, AW, MELEE } from '../constants.js';
import { en, dst, effEv, isStunned, blN, addBl, addCh, getSdm, addLog } from '../combat/engine.js';
import { spLightning, spFloat, spSparks, spFire, spPoison, spSmoke, spShadow, spStun, spDrips } from '../render/particles.js';
import { mkFollower } from '../combat/hero.js';

export const ALL_SKILLS=[
  {id:'chainLightning',icon:'\u26A1',name:'Chain Lightning',source:'Mage',desc:'260dmg+stun 5sCD 40mana',ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<40||d>(h.spellRange||400))return false;h.resource-=40;h.spells.skill0.cd=5000;h.castAnim=1;if(Math.random()<effEv(e)*0.6){addLog(t,'Chain DODGED!','miss');return true}var dm=260*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;spLightning(h.x,h.y-40,e.x,e.y-30);spFloat(e.x,e.y-60,'\u26A1'+Math.round(dm),'#44ddbb');addLog(t,'Chain>'+e.name+' '+Math.round(dm),'shock');e.shocked=true;e.shockedEnd=t+3000;e.slow=0.12;e.slowEnd=t+1500;if(!e.stealthed&&!(e.type==='barbarian')){e.stunEnd=t+450;spStun(e.x,e.y-50)}return true}},
  {id:'lightningBolt',icon:'\u{1F537}',name:'Lightning Bolt',source:'Mage',desc:'140dmg 2.2sCD 20mana',ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<20||d>(h.spellRange||400))return false;h.resource-=20;h.spells.skill0.cd=2200;h.castAnim=1;if(Math.random()<effEv(e)*0.6){addLog(t,'Bolt DODGED!','miss');return true}var dm=140*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;spFloat(e.x,e.y-50,'\u26A1'+Math.round(dm),'#88ffdd');spSparks(e.x,e.y-30,3,'#44ddbb');addLog(t,'Bolt>'+e.name+' '+Math.round(dm),'shock');return true}},
  {id:'staticShield',icon:'\u{1F6E1}',name:'Static Shield',source:'Mage',desc:'380HP shield 10sCD 55mana',ai:function(h,t){if(h.spells.skill0.cd>0||(h.resource||0)<55||h.hp/h.maxHp>.65||h.shieldActive)return false;h.resource-=55;h.spells.skill0.cd=10000;h.shieldActive=true;h.shieldHp=380;h.shieldEnd=t+5000;h.castAnim=1;addLog(t,h.name+' Shield!','spell');return true}},
  {id:'huntersMark',icon:'\u{1F3AF}',name:"Hunter's Mark",source:'Archer',desc:'Slow+guaranteed hit 8sCD',ai:function(h,t){var e=en(h);if(h.spells.skill0.cd>0||blN(e)<1)return false;e.slow=.01*blN(e);e.slowEnd=t+2000;h.markNext=true;addBl(e,t);h.spells.skill0.cd=8000;h.castAnim=1;addLog(t,h.name+' Mark!','spell');return true}},
  {id:'bloodlust',icon:'\u{1FA78}',name:'Bloodlust',source:'Archer',desc:'AtkSpd+heal 12sCD',ai:function(h,t){var e=en(h);if(h.spells.skill0.cd>0||blN(e)<2)return false;h.blActive=true;h.blEnd=t+2500;h.blDmg=0;h.spells.skill0.cd=12000;h.castAnim=1;spFire(h.x,h.y-30,6);addLog(t,h.name+' Bloodlust!','spell');return true}},
  {id:'sacrifice',icon:'\u{1F525}',name:'Summon Pet',source:'Archer',desc:'Fire pet 15sCD',ai:function(h,t){if(h.spells.skill0.cd>0||h.followerAlive)return false;h.follower=mkFollower(h);h.followerAlive=true;h.spells.skill0.cd=15000;h.castAnim=1;spFire(h.follower.x,h.follower.y-15,6);addLog(t,h.name+' summons pet!','summon');return true}},
  {id:'shadowStep',icon:'\u{1F4A8}',name:'Shadow Step',source:'Rogue',desc:'Teleport+stealth 3.5sCD 25res',ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<25||d<=100||h.stealthed)return false;h.resource-=25;h.spells.skill0.cd=3500;h.castAnim=1;spShadow(h.x,h.y-20);h.x=Math.max(AX+25,Math.min(AX+AW-25,e.x+(e.x>h.x?50:-50)));h.stealthed=true;h.stealthEnd=t+2000;h.combo=Math.min(h.maxCombo||5,(h.combo||0)+2);spShadow(h.x,h.y-20);addLog(t,h.name+' Shadow Step!','stealth');return true}},
  {id:'envenom',icon:'\u2620',name:'Envenom',source:'Rogue',desc:'Poison 5s 8sCD 30res',ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||(h.resource||0)<30||d>(h.meleeRange||MELEE)+60)return false;h.resource-=30;h.spells.skill0.cd=8000;h.castAnim=1;h.envenomed=true;h.envenomedEnd=t+5000;spPoison(h.x,h.y-30,6);addLog(t,h.name+' Envenom!','poison');return true}},
  {id:'smokeBomb',icon:'\u{1F4A3}',name:'Smoke Bomb',source:'Rogue',desc:'+45%eva 4s 12sCD 35res',ai:function(h,t){if(h.spells.skill0.cd>0||(h.resource||0)<35||h.hp/h.maxHp>.55||h.smokeBombActive)return false;h.resource-=35;h.spells.skill0.cd=12000;h.castAnim=1;h.smokeBombActive=true;h.smokeBombEnd=t+4000;h.smokeBombX=h.x;spSmoke(h.x,h.y-20,15);addLog(t,h.name+' Smoke Bomb!','stealth');return true}},
  {id:'charge',icon:'\u{1F4A5}',name:'Charge',source:'Warrior',desc:'Dash+200dmg 5.5sCD',ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||d<100||d>350)return false;h.spells.skill0.cd=5500;h.castAnim=1;spSparks(h.x,h.y-20,6,'#cc4444');h.x=Math.max(AX+25,Math.min(AX+AW-25,e.x-(e.x>h.x?1:-1)*45));var dm=200*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;spFloat(e.x,e.y-60,'\u{1F4A5}'+Math.round(dm),'#cc4444');spSparks(e.x,e.y-30,8,'#ff6666');addLog(t,h.name+' CHARGE '+Math.round(dm)+'!','dmg');return true}},
  {id:'warCry',icon:'\u{1F4E2}',name:'War Cry',source:'Warrior',desc:'Slow25% 2.5s 10sCD',ai:function(h,t){var e=en(h),d=dst(h,e);if(h.spells.skill0.cd>0||d>150)return false;h.spells.skill0.cd=10000;h.castAnim=1;e.slow=0.25;e.slowEnd=t+2500;spSparks(h.x,h.y-30,6,'#ffaa44');addLog(t,h.name+' WAR CRY!','spell');return true}},
];

export const ALL_ULTS=[
  {id:'thunderstorm',icon:'\u26A1',name:'Thunderstorm',source:'Mage',desc:'5x200dmg+heal @25%HP',threshold:0.25,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.25)return false;h.spells.ultimate.used=true;h.ultActive=true;h.ultEnd=t+2500;h.ultStrikes=5;h.ultStrikeTimer=0;h.castAnim=1;spSparks(h.x,h.y-40,12,'#44ddbb');addLog(t,'\u26A1 '+h.name+' THUNDERSTORM!','ult');return true},proc:function(h,t,dt){if(!h.ultActive||!h.ultStrikes||h.ultStrikes<=0)return;h.ultStrikeTimer=(h.ultStrikeTimer||0)+dt;if(h.ultStrikeTimer>=450){h.ultStrikeTimer=0;h.ultStrikes--;var e=en(h);var dm=200*(1+(h.spellDmgBonus||0))*(1-Math.min(e.def/300,.8));e.hp-=dm;h.totDmg+=dm;e.hurtAnim=1;var hl=dm*0.42;h.hp=Math.min(h.maxHp,h.hp+hl);h.totHeal+=hl;spLStrike(e.x);spFloat(e.x,e.y-65,'\u26A1'+Math.round(dm),'#44ddbb');spFloat(h.x,h.y-55,'+'+Math.round(hl),'#44aa66');addLog(t,'Storm '+Math.round(dm)+' heal '+Math.round(hl),'ult')}}},
  {id:'rainOfFire',icon:'\u{1F525}',name:'Rain of Fire',source:'Archer',desc:'2s invuln+3xAS @20%HP',threshold:0.20,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.20)return false;h.spells.ultimate.used=true;h.ultActive=true;h.ultEnd=t+2000;h.castAnim=1;spFire(h.x,h.y-30,15);addLog(t,'\u{1F525} '+h.name+' RAIN OF FIRE!','ult');return true}},
  {id:'deathMark',icon:'\u2620',name:'Death Mark',source:'Rogue',desc:'85% stored dmg @20%HP',threshold:0.20,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.20)return false;h.spells.ultimate.used=true;h.castAnim=1;h.combo=h.maxCombo||5;var e=en(h);e.deathMarkTarget=true;e.deathMarkEnd=t+3500;e.deathMarkDmg=0;spSparks(e.x,e.y-30,10,'#ff8800');spFloat(e.x,e.y-70,'DEATH MARK','#ff8800');addLog(t,'\u2620 '+h.name+' DEATH MARK!','ult');return true}},
  {id:'berserker',icon:'\u{1F480}',name:'Berserker Rage',source:'Warrior',desc:'4s +40%AS +25%Dmg @30%HP',threshold:0.30,ai:function(h,t){if(h.spells.ultimate.used||h.hp/h.maxHp>=0.30)return false;h.spells.ultimate.used=true;h.ultActive=true;h.ultEnd=t+4000;h.castAnim=1;spSparks(h.x,h.y-40,12,'#cc4444');spFloat(h.x,h.y-70,'BERSERKER','#ff4444');addLog(t,'\u{1F480} '+h.name+' BERSERKER RAGE!','ult');return true}},
];
